<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OCPP Dashboard</title>

  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121a;
      --line:#1f2a37; --line2:#2b3a4c;
      --txt:#e6edf3; --muted:#9aa4b2;
      --ok:#22c55e; --bad:#ef4444; --pri:#8b5cf6; --warn:#f59e0b;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Arial}
    header{
      position:sticky;top:0;z-index:5;
      padding:14px 18px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(11,15,20,0.98), rgba(11,15,20,0.92));
      backdrop-filter: blur(6px);
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:18px}
    .brand span{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .wrap{padding:16px 18px;max-width:1300px;margin:auto}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr 1.25fr 1.6fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
    }
    .card h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:12px}
    .pill{
      padding:5px 10px;border-radius:999px;border:1px solid var(--line2);
      font-size:12px;display:inline-flex;gap:8px;align-items:center
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--bad);display:inline-block}
    .ok .dot{background:var(--ok)}
    .bad .dot{background:var(--bad)}
    .warn .dot{background:var(--warn)}
    input,select,button,textarea{
      background:var(--panel2);
      color:var(--txt);
      border:1px solid var(--line2);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
    }
    button{cursor:pointer}
    button:hover{border-color:var(--pri)}
    button.primary{border-color:rgba(139,92,246,.65)}
    button.primary:hover{border-color:var(--pri)}
    button.ghost{background:transparent}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .split{grid-template-columns:1fr} }

    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    th{font-size:12px;color:var(--muted);font-weight:600}
    td{font-size:13px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    .btns button{padding:8px 10px;border-radius:10px}

    .mono{
      white-space:pre-wrap;
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      max-height:420px;
      overflow:auto;
    }
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:6px 0 10px}
    .toolbar .left,.toolbar .right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 8px;border-radius:999px;border:1px solid var(--line2);
      font-size:11px;color:var(--muted)
    }
    .badge strong{color:var(--txt);font-weight:650}
    .kv{display:flex;gap:10px;flex-wrap:wrap}
    .kv .badge{background:rgba(255,255,255,.02)}
    .small{font-size:11px}

    /* ============ LOG FORMATADO (cards) ============ */
    .logWrap { display:flex; flex-direction:column; gap:10px; }
    .logEntry{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 12px;
      padding:10px 12px;
    }
    .logTop{display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap}
    .logTag{
      display:inline-flex; gap:8px; align-items:center;
      font-size:12px; padding:4px 10px; border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
    }
    .logTag .d{width:8px;height:8px;border-radius:50%}
    .logSerial{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:650}
    .logAction{color:var(--muted); font-size:12px}
    .logMsg{margin-top:8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap}
    .logJson{
      margin-top:8px;
      background: var(--panel2);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      overflow:auto;
    }
    .meterGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px;
    }
    @media (max-width:900px){ .meterGrid{grid-template-columns:1fr 1fr} }
    .meterItem{
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:8px 10px;
    }
    .meterItem .k{color:var(--muted); font-size:11px}
    .meterItem .v{font-weight:700; font-size:14px}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <b>OCPP Dashboard</b>
    <span>Online ‚Ä¢ comandos ‚Ä¢ logs ‚Ä¢ debug r√°pido</span>
  </div>

  <div class="row">
    <span id="statusPill" class="pill bad"><span class="dot"></span><span id="statusText">desconhecido</span></span>
    <button class="ghost" onclick="refreshClients()">Atualizar</button>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="toolbar">
      <div class="left">
        <h3 style="margin:0">Status</h3>
        <span class="badge">Gateway: <strong id="gw">(carregando‚Ä¶)</strong></span>
        <span class="badge">Online: <strong id="onlineCount">0</strong></span>
      </div>
      <div class="right">
        <label class="badge">
          Poll (s)
          <select id="pollSec" onchange="setPoll()" style="padding:6px 8px">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </label>
        <label class="badge">
          Buscar
          <input id="search" oninput="renderClients()" placeholder="serial‚Ä¶" style="padding:6px 10px; width:170px"/>
        </label>
      </div>
    </div>
    <div class="muted">O painel considera ‚Äúonline‚Äù o que o gateway exp√µe em <code>/ocpp/clients</code>. (Heartbeat deve atualizar o gateway.)</div>
  </div>

  <div class="grid">

    <!-- COL 1: ONLINE -->
    <div class="card">
      <h3>Carregadores online</h3>
      <div class="muted" style="margin-bottom:10px">Clique em um serial para pr√©-preencher o comando.</div>
      <table>
        <thead>
          <tr>
            <th style="width:35%">Serial</th>
            <th>A√ß√µes r√°pidas</th>
          </tr>
        </thead>
        <tbody id="clientsBody">
          <tr><td colspan="2" class="muted">Carregando‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <!-- COL 2: COMANDOS -->
    <div class="card">
      <h3>Enviar comando (CS ‚Üí CP)</h3>
      <div class="muted">Chama <code>/api/send</code> e repassa para o gateway.</div>

      <div class="split" style="margin-top:12px">
        <input id="serial" placeholder="serialNumber (ex: 2222233333)"/>
        <select id="action" onchange="applyTemplate()"></select>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <div class="left">
          <span class="badge">Template: <strong id="tplName">‚Äî</strong></span>
          <span class="badge">Dica: <span id="hint" class="small">Selecione a a√ß√£o</span></span>
        </div>
        <div class="right">
          <button class="ghost" onclick="applyTemplate()">Aplicar</button>
          <button class="ghost" onclick="clearPayload()">Limpar</button>
        </div>
      </div>

      <textarea id="payload" rows="12" style="width:100%">{}</textarea>

      <div class="row" style="margin-top:12px;justify-content:space-between">
        <div class="row">
          <button class="primary" onclick="sendCmd()">Enviar</button>
          <button class="ghost" onclick="copyPayload()">Copiar payload</button>
        </div>
        <div class="muted small">Resposta abaixo</div>
      </div>

      <div style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Resposta</h3>
        <pre id="resp" class="mono">{}</pre>
      </div>
    </div>

    <!-- COL 3: LOGS -->
    <div class="card">
      <h3>Logs</h3>

      <div class="toolbar">
        <div class="left">
          <select id="logType">
            <option value="gateway">Gateway OCPP</option>
            <option value="gateway_err">Gateway Erros</option>
            <option value="dashboard">Dashboard</option>
            <option value="dashboard_err">Dashboard Erros</option>
            <option value="nginx">Nginx error</option>
            <option value="nginx_access">Nginx access</option>
          </select>
          <button onclick="loadLogs(true)">Carregar</button>
        </div>

        <div class="right">
          <label class="badge">
            Modo
            <select id="logMode" onchange="resetLogState()" style="padding:6px 8px">
              <option value="full" selected>Completo</option>
              <option value="new">Somente novos</option>
            </select>
          </label>
          <label class="badge">
            Atualiza (s)
            <select id="logPollSec" onchange="setLogPoll()" style="padding:6px 8px">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="5">5</option>
              <option value="10">10</option>
            </select>
          </label>
          <button class="ghost" onclick="clearLogsBox()">Limpar tela</button>
        </div>
      </div>

      <div class="muted" style="margin-bottom:10px">
        <span class="badge">üí° Dica</span>
        Se o server retorna ‚Äútail‚Äù, o in√≠cio muda. No modo <b>Completo</b> o painel sempre renderiza o retorno inteiro (n√£o corta).
      </div>

      <!-- era <pre> ... agora √© div para render HTML -->
      <div id="logsBox" class="mono" style="height:440px"></div>
    </div>

  </div>
</div>

<script>
  // =========================
  // Templates OCPP 1.6J (CS -> CP)
  // =========================
  const COMMANDS = [
    // Core
    { group:"Core", action:"RemoteStartTransaction", tpl:{ idTag:"TARGET001", connectorId:1 } },
    { group:"Core", action:"RemoteStopTransaction", tpl:{ transactionId:12345 } },
    { group:"Core", action:"UnlockConnector", tpl:{ connectorId:1 } },
    { group:"Core", action:"Reset", tpl:{ type:"Soft" } }, // Soft | Hard
    { group:"Core", action:"ChangeAvailability", tpl:{ connectorId:1, type:"Operative" } }, // Operative | Inoperative
    { group:"Core", action:"ClearCache", tpl:{} },
    { group:"Core", action:"GetConfiguration", tpl:{ key:[] } }, // [] => tudo
    { group:"Core", action:"ChangeConfiguration", tpl:{ key:"HeartbeatInterval", value:"60" } },
    { group:"Core", action:"DataTransfer", tpl:{ vendorId:"SeuVendor", messageId:"ping", data:"hello" } },

    // Firmware Management
    { group:"Firmware", action:"GetDiagnostics", tpl:{ location:"https://ocpptarget.cloud/diag", retries:1, retryInterval:60 } },
    { group:"Firmware", action:"UpdateFirmware", tpl:{ location:"https://ocpptarget.cloud/fw.bin", retries:1, retryInterval:60, retrieveDate:new Date(Date.now()+5*60*1000).toISOString() } },

    // Remote Trigger
    { group:"Trigger", action:"TriggerMessage", tpl:{ requestedMessage:"StatusNotification", connectorId:1 } },

    // Reservation
    { group:"Reservation", action:"ReserveNow", tpl:{ connectorId:1, expiryDate:new Date(Date.now()+30*60*1000).toISOString(), idTag:"TARGET001", reservationId:101 } },
    { group:"Reservation", action:"CancelReservation", tpl:{ reservationId:101 } },

    // Local Auth List Management
    { group:"LocalAuth", action:"GetLocalListVersion", tpl:{} },
    { group:"LocalAuth", action:"SendLocalList", tpl:{
      listVersion: 1,
      updateType: "Full", // Full | Differential
      localAuthorizationList: [
        { idTag: "TARGET001", idTagInfo: { status: "Accepted" } }
      ]
    } },

    // Smart Charging
    { group:"SmartCharging", action:"ClearChargingProfile", tpl:{ id: null, connectorId: 0, chargingProfilePurpose: "TxProfile", stackLevel: 0 } },
    { group:"SmartCharging", action:"GetCompositeSchedule", tpl:{ connectorId:1, duration:3600, chargingRateUnit:"A" } }, // "A" or "W"
    { group:"SmartCharging", action:"SetChargingProfile", tpl:{
      connectorId: 1,
      csChargingProfiles: {
        chargingProfileId: 1,
        stackLevel: 0,
        chargingProfilePurpose: "TxProfile",
        chargingProfileKind: "Absolute",
        chargingSchedule: {
          duration: 3600,
          startSchedule: new Date().toISOString(),
          chargingRateUnit: "A",
          chargingSchedulePeriod: [
            { startPeriod: 0, limit: 16, numberPhases: 1 }
          ]
        }
      }
    } }
  ];

  function fillActions(){
    const sel = document.getElementById("action");
    sel.innerHTML = "";
    const groups = [...new Set(COMMANDS.map(c => c.group))];

    for (const g of groups){
      const og = document.createElement("optgroup");
      og.label = g;
      COMMANDS.filter(c => c.group === g).forEach(c => {
        const op = document.createElement("option");
        op.value = c.action;
        op.textContent = c.action;
        og.appendChild(op);
      });
      sel.appendChild(og);
    }
  }

  function getTemplate(action){
    const found = COMMANDS.find(c => c.action === action);
    return found ? found.tpl : {};
  }

  // =========================
  // Status
  // =========================
  function setPill(state){
    const pill = document.getElementById("statusPill");
    const text = document.getElementById("statusText");
    pill.classList.remove("ok","bad","warn");
    pill.classList.add(state);
    text.textContent = (state === "ok") ? "gateway ok" : (state === "warn" ? "parcial" : "gateway erro");
  }

  async function loadConfig(){
    try{
      const r = await fetch("/api/config");
      const j = await r.json();
      document.getElementById("gw").textContent = j.gatewayUrl || "(indefinido)";
    }catch(e){
      document.getElementById("gw").textContent = "(erro lendo config)";
    }
  }

  // =========================
  // Clients
  // =========================
  let clientsRaw = [];
  async function refreshClients(){
    try{
      const r = await fetch("/api/clients");
      const j = await r.json();
      const list = Array.isArray(j) ? j : (j.clients || []);
      clientsRaw = list;
      setPill("ok");
      renderClients();
    }catch(e){
      clientsRaw = [];
      setPill("bad");
      renderClients();
    }
  }

  function normalizeSerial(x){
    if (typeof x === "string") return x;
    if (!x || typeof x !== "object") return String(x ?? "");
    return x.serialNumber || x.chargePointId || x.id || x.sn || "[obj]";
  }

  function renderClients(){
    const body = document.getElementById("clientsBody");
    const q = (document.getElementById("search").value || "").trim().toLowerCase();

    const list = clientsRaw.map(normalizeSerial).filter(Boolean);
    const filtered = q ? list.filter(s => s.toLowerCase().includes(q)) : list;

    document.getElementById("onlineCount").textContent = String(filtered.length);

    if(!filtered.length){
      body.innerHTML = '<tr><td colspan="2" class="muted">Nenhum carregador online</td></tr>';
      return;
    }

    body.innerHTML = filtered.map(sn => `
      <tr>
        <td>
          <b style="cursor:pointer" onclick="pickSerial('${escapeHtml(sn)}')">${escapeHtml(sn)}</b>
          <div class="muted small">via gateway</div>
        </td>
        <td>
          <div class="btns">
            <button onclick="quick('${escapeHtml(sn)}','Status')">Trigger Status</button>
            <button onclick="quick('${escapeHtml(sn)}','Meter')">Trigger Meter</button>
            <button onclick="quick('${escapeHtml(sn)}','SoftReset')">Soft Reset</button>
          </div>
        </td>
      </tr>
    `).join("");
  }

  function pickSerial(sn){
    document.getElementById("serial").value = sn;
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // Command send
  // =========================
  function applyTemplate(){
    const action = document.getElementById("action").value;
    const tpl = getTemplate(action);
    document.getElementById("payload").value = JSON.stringify(tpl || {}, null, 2);
    document.getElementById("tplName").textContent = action;
    document.getElementById("hint").textContent = "template aplicado";
  }

  function clearPayload(){
    document.getElementById("payload").value = "{}";
    document.getElementById("hint").textContent = "payload limpo";
  }

  function copyPayload(){
    const txt = document.getElementById("payload").value || "";
    navigator.clipboard?.writeText(txt);
    document.getElementById("hint").textContent = "payload copiado";
  }

  async function sendCmd(){
    const serialNumber = (document.getElementById("serial").value || "").trim();
    const action = document.getElementById("action").value;

    if(!serialNumber){
      document.getElementById("resp").textContent = "Informe o serialNumber.";
      return;
    }

    let payload = {};
    try{
      payload = JSON.parse(document.getElementById("payload").value || "{}");
    }catch(e){
      document.getElementById("resp").textContent = "Payload JSON inv√°lido.";
      return;
    }

    try{
      const r = await fetch("/api/send", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ serialNumber, action, payload })
      });
      const txt = await r.text();
      document.getElementById("resp").textContent = txt;
    }catch(e){
      document.getElementById("resp").textContent = String(e?.message || e);
    }
  }

  async function quick(sn, type){
    pickSerial(sn);
    if(type === "Status"){
      document.getElementById("action").value = "TriggerMessage";
      document.getElementById("payload").value = JSON.stringify({ requestedMessage:"StatusNotification", connectorId:1 }, null, 2);
    }
    if(type === "Meter"){
      document.getElementById("action").value = "TriggerMessage";
      document.getElementById("payload").value = JSON.stringify({ requestedMessage:"MeterValues", connectorId:1 }, null, 2);
    }
    if(type === "SoftReset"){
      document.getElementById("action").value = "Reset";
      document.getElementById("payload").value = JSON.stringify({ type:"Soft" }, null, 2);
    }
    await sendCmd();
  }

  // =========================
  // Log parsing/formatting
  // =========================
  function colorByType(tag){
    const t = (tag || "").toUpperCase();
    if (t.includes("OCPP IN")) return "var(--pri)";
    if (t.includes("OCPP OUT")) return "#06b6d4";
    if (t.includes("METER")) return "var(--ok)";
    if (t.includes("ERROR")) return "var(--bad)";
    if (t.includes("WS")) return "var(--warn)";
    return "var(--muted)";
  }

  function safeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function tryParseJsonFromLine(line){
    const m = line.match(/\{[\s\S]*\}$/);
    if(!m) return null;
    try { return JSON.parse(m[0]); } catch { return null; }
  }

  function summarizeMeter(json){
    const points = Array.isArray(json?.points) ? json.points : [];
    const pick = (meas) => points.find(p => p.measurand === meas);

    const energy = pick("Energy.Active.Import.Register");
    const power  = pick("Power.Active.Import");
    const soc    = pick("SoC");
    const curr   = pick("Current.Import");
    const volt   = pick("Voltage");
    const temp   = pick("Temperature");

    const fmt = (p) => p ? `${p.value} ${p.unit || ""}`.trim() : "‚Äî";

    let energyText = "‚Äî";
    if (energy?.value != null) {
      const wh = Number(energy.value);
      if (!Number.isNaN(wh)) {
        const kwh = wh / 1000;
        energyText = `${wh} Wh  (${kwh.toFixed(3)} kWh)`;
      } else {
        energyText = fmt(energy);
      }
    }

    return {
      "Energia total": energyText,
      "Pot√™ncia": fmt(power),
      "SoC": fmt(soc),
      "Corrente": fmt(curr),
      "Tens√£o": fmt(volt),
      "Temperatura": fmt(temp),
    };
  }

  function parseLogLinesToEntries(text){
    const lines = String(text || "").split("\n").filter(l => l.trim().length);
    return lines.map(line => {
      const tagMatch = line.match(/^\[([^\]]+)\]/);
      const tag = tagMatch ? tagMatch[1] : "LOG";

      const snMatch = line.match(/^\[[^\]]+\]\s+([0-9]{3,})/);
      const serial = snMatch ? snMatch[1] : "";

      const actionMatch = line.match(/action=([A-Za-z0-9_]+)/);
      const action = actionMatch ? actionMatch[1] : "";

      const json = tryParseJsonFromLine(line);

      return { raw: line, tag, serial, action, json };
    });
  }

  function renderLogEntries(text){
    const box = document.getElementById("logsBox");
    const entries = parseLogLinesToEntries(text);

    let html = `<div class="logWrap">`;

    for (const e of entries){
      const c = colorByType(e.tag);

      // conte√∫do principal sem JSON duplicado
      let main = e.raw;
      const jsonMatch = main.match(/\{[\s\S]*\}$/);
      if (jsonMatch) main = main.slice(0, jsonMatch.index).trim();

      html += `<div class="logEntry">
        <div class="logTop">
          <div class="row" style="gap:8px">
            <span class="logTag">
              <span class="d" style="background:${c}"></span>
              <strong>${safeHtml(e.tag)}</strong>
            </span>
            ${e.serial ? `<span class="logSerial">${safeHtml(e.serial)}</span>` : ``}
            ${e.action ? `<span class="logAction">‚Ä¢ ${safeHtml(e.action)}</span>` : ``}
          </div>
          <div class="muted small">${new Date().toLocaleTimeString()}</div>
        </div>

        <div class="logMsg">${safeHtml(main)}</div>
      `;

      if (String(e.tag).toUpperCase().includes("METER") && e.json?.points){
        const sum = summarizeMeter(e.json);
        html += `<div class="meterGrid">`;
        for (const [k,v] of Object.entries(sum)){
          html += `<div class="meterItem"><div class="k">${safeHtml(k)}</div><div class="v">${safeHtml(v)}</div></div>`;
        }
        html += `</div>`;
      }

      if (e.json){
        html += `<div class="logJson">${safeHtml(JSON.stringify(e.json, null, 2))}</div>`;
      }

      html += `</div>`;
    }

    html += `</div>`;
    box.innerHTML = html || "";
  }

  // =========================
  // Logs (sem cortar in√≠cio no front) + modo "novos" com buffer
  // =========================
  let logTimer = null;
  let lastRendered = ""; // para modo "Somente novos"
  let logBuffer = "";    // texto que o painel est√° exibindo (formatado via renderLogEntries)

  function resetLogState(){
    lastRendered = "";
    logBuffer = "";
    loadLogs(true);
  }

  function setLogPoll(){
    if (logTimer) clearInterval(logTimer);
    const sec = Number(document.getElementById("logPollSec").value || "2");
    loadLogs(false);
    logTimer = setInterval(() => loadLogs(false), sec * 1000);
  }

  function clearLogsBox(){
    document.getElementById("logsBox").innerHTML = "";
    lastRendered = "";
    logBuffer = "";
  }

  async function loadLogs(force){
    const t = document.getElementById("logType").value;
    let j;
    try{
      const r = await fetch(`/api/logs/${t}`);
      j = await r.json();
    }catch(e){
      return;
    }
    if (!j?.ok) return;

    const current = String(j.log || "");
    const mode = document.getElementById("logMode").value;

    if (mode === "full"){
      // ‚úÖ sempre renderiza o retorno completo
      if (force || lastRendered !== current){
        logBuffer = current;
        renderLogEntries(logBuffer);
      }
      lastRendered = current;
      return;
    }

    // mode === "new"
    if (!lastRendered){
      logBuffer = current;
      renderLogEntries(logBuffer);
      lastRendered = current;
      return;
    }

    if (current.includes(lastRendered)){
      const newPart = current.slice(current.indexOf(lastRendered) + lastRendered.length).trim();
      if (newPart){
        // coloca o novo por CIMA no buffer (mais recente em cima)
        logBuffer = (newPart + "\n" + logBuffer).trim();
        renderLogEntries(logBuffer);
      }
      lastRendered = current;
    }else{
      // tail ‚Äúandou‚Äù: evita bug de corte
      logBuffer = (current + "\n" + logBuffer).trim();
      renderLogEntries(logBuffer);
      lastRendered = current;
    }
  }

  // =========================
  // Poll / init
  // =========================
  let pollTimer = null;
  function setPoll(){
    if (pollTimer) clearInterval(pollTimer);
    const sec = Number(document.getElementById("pollSec").value || "3");
    refreshClients();
    pollTimer = setInterval(refreshClients, sec * 1000);
  }

  fillActions();
  loadConfig();
  applyTemplate();
  setPoll();
  setLogPoll();
</script>
</body>
</html>
